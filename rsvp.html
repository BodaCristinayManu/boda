<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RSVP - Cristina & Manu</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .form-card { background: #fff; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.06); padding: 1.25rem; }
    .btn-primary { background:#004466; color:#fff; padding:0.5rem 1.25rem; border-radius:8px; font-weight:500; }
    .btn-primary:disabled { opacity:0.6; cursor:not-allowed; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
  </style>
</head>
<body class="text-[#004466] bg-[#F8EBD8]">

<main class="max-w-3xl mx-auto p-6">
  <h1 class="text-2xl font-serif mb-4">Confirmar asistencia</h1>

  <!-- FORMULARIO: action apunta al Apps Script, target al iframe para no salir de la página -->
  <form id="rsvpForm" class="form-card" novalidate
        action="https://script.google.com/macros/s/AKfycbxmglZywqeZDp8Qdq2HqtpCf6AcRwsh_H_kXXBXgC4lOxb58-Fmi_l7J1SO0m9upG8t/exec"
        method="POST"
        target="hidden_iframe">

    <!-- Hidden token for Apps Script -->
    <input type="hidden" name="_token" id="token_field" value="Estrasburgo141224">

    <!-- BLOQUE 1: Contacto básico -->
    <div class="grid gap-4 mb-4">
      <label for="nombre"><span class="text-sm font-medium">Nombre completo *</span></label>
      <input id="nombre" name="nombre" required class="w-full p-2 border rounded mt-1" autocomplete="name" />

      <label for="email"><span class="text-sm font-medium">Email *</span></label>
      <input id="email" name="email" type="email" required class="w-full p-2 border rounded mt-1" autocomplete="email" />
    </div>

    <!-- BLOQUE 2: Asistencia -->
    <div class="mb-4">
      <p class="text-sm font-medium mb-2">¿Nos acompañas? *</p>
      <div class="flex gap-4 items-center">
        <div class="inline-flex items-center">
          <input id="asiste_si" type="radio" name="asiste" value="Sí, allí estaré" checked class="mr-2">
          <label for="asiste_si" class="text-sm">Sí, allí estaré</label>
        </div>
        <div class="inline-flex items-center">
          <input id="asiste_no" type="radio" name="asiste" value="No puedo, lo siento" class="mr-2">
          <label for="asiste_no" class="text-sm">No puedo, lo siento</label>
        </div>
      </div>
    </div>

    <!-- BLOQUES CONDICIONALES -->
    <div id="conditionalBlocks">
      <label for="num_inv" class="block mt-3"><span class="text-sm font-medium">¿Cuántas personas vendréis a la boda (incluyéndote)? *</span></label>
      <input id="num_inv" type="number" min="1" name="num_inv" required class="w-36 p-2 border rounded mt-1" />

      <div id="companionsBlock" class="mt-3 hidden">
        <p class="text-sm font-medium mb-2">Nombre y apellidos de los acompañantes *</p>
        <div id="companionsList" class="space-y-2"></div>
      </div>

      <label for="alojamiento" class="block mt-3"><span class="text-sm font-medium">¿Necesitas alojamiento? *</span></label>
      <select id="alojamiento" name="alojamiento" required class="w-full p-2 border rounded mt-1">
        <option value="">Selecciona una opción</option>
        <option value="No">No</option>
        <option value="Sí - prefiero hotel">Sí - prefiero hotel</option>
        <option value="Sí - prefiero apartamento">Sí - prefiero apartamento</option>
      </select>

      <label for="transporte" class="block mt-3"><span class="text-sm font-medium">¿Necesitas transporte el día del evento? *</span></label>
      <select id="transporte" name="transporte" required class="w-full p-2 border rounded mt-1">
        <option value="">Selecciona una opción</option>
        <option value="No">No</option>
        <option value="Sí - a la ida">Sí - a la ida</option>
        <option value="Sí - a la vuelta">Sí - a la vuelta</option>
        <option value="Sí - ida y vuelta">Sí - ida y vuelta</option>
      </select>

      <div id="extraTransportBlock" class="mb-4 mt-4 hidden">
        <p class="text-sm font-medium mb-2">¿Piensas irte antes del final del evento? (en torno a las 6h00 de la mañana) *</p>
        <div class="flex flex-col gap-2">
          <div class="inline-flex items-center">
            <input id="salida_si" type="radio" name="salida_antes" value="Sí" class="mr-2">
            <label for="salida_si">Sí</label>
          </div>
          <div class="inline-flex items-center">
            <input id="salida_no" type="radio" name="salida_antes" value="No, ¡aguantaré hasta el final!" class="mr-2">
            <label for="salida_no">No, ¡aguantaré hasta el final!</label>
          </div>
        </div>
      </div>

      <div class="mb-4 mt-3">
        <label for="alergias"><span class="text-sm font-medium">Alergias / Restricciones alimentarias / Menú Vegetariano o Vegano</span></label>
        <textarea id="alergias" name="alergias" rows="3" class="w-full p-2 border rounded mt-1"></textarea>
      </div>

      <div class="grid gap-4 mb-4">
        <label for="cancion"><span class="text-sm font-medium">Dinos alguna canción que te gustaría escuchar</span></label>
        <input id="cancion" name="cancion" class="w-full p-2 border rounded mt-1" />

        <label for="comentarios"><span class="text-sm font-medium">¿Tienes alguna pregunta?</span></label>
        <textarea id="comentarios" name="comentarios" rows="4" class="w-full p-2 border rounded mt-1"></textarea>
      </div>
    </div>

    <div class="flex items-center gap-4">
      <button id="submitBtn" type="submit" class="btn-primary">Enviar RSVP</button>
      <div id="formStatus" class="text-sm text-green-600 hidden">Enviado. ¡Gracias!</div>
    </div>
  </form>

  <!-- iframe invisible para recibir la respuesta sin salir de la página -->
  <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
</main>

<script>
(() => {
  // === CONFIG (no cambiar) ===
  const APPS_SCRIPT_TOKEN = "Estrasburgo141224";
  // ===========================

  // elementos
  const form = document.getElementById('rsvpForm');
  const status = document.getElementById('formStatus');
  const submitBtn = document.getElementById('submitBtn');
  const companionsList = document.getElementById('companionsList');
  const companionsBlock = document.getElementById('companionsBlock');
  const numInvInput = document.getElementById('num_inv');
  const transporteSelect = document.getElementById('transporte');
  const extraTransportBlock = document.getElementById('extraTransportBlock');

  // Token hidden
  const tokenField = document.getElementById('token_field');
  if (tokenField) tokenField.value = APPS_SCRIPT_TOKEN;

  // companion counter
  let companionCounter = 0;

  // helpers (igual que antes)
  function updateCompanions() {
    if (!numInvInput) return;
    const total = parseInt(numInvInput.value,10) || 1;
    companionsList.innerHTML = '';
    companionCounter = 0;
    if (total > 1) {
      companionsBlock.classList.remove('hidden');
      for (let i=1; i<total; i++) {
        companionCounter++;
        const id = `acompanante_${companionCounter}`;
        const wrapper = document.createElement('div');
        wrapper.className = 'flex gap-2 items-center';
        wrapper.innerHTML = `
          <label for="${id}" class="sr-only">Acompañante ${i}</label>
          <input id="${id}" name="${id}" placeholder="Nombre acompañante" required class="w-full p-2 border rounded" />
        `;
        companionsList.appendChild(wrapper);
      }
    } else {
      companionsBlock.classList.add('hidden');
    }
  }

  function toggleTransportQuestion() {
    if (!transporteSelect) return;
    if (transporteSelect.value === 'Sí - a la vuelta' || transporteSelect.value === 'Sí - ida y vuelta') {
      extraTransportBlock.classList.remove('hidden');
      extraTransportBlock.querySelectorAll('input[type="radio"]').forEach(r => r.required = true);
    } else {
      extraTransportBlock.classList.add('hidden');
      extraTransportBlock.querySelectorAll('input[type="radio"]').forEach(r => { r.required = false; r.checked = false; });
    }
  }

  function setRequiredIn(container, required) {
    const optional = ['alergias','cancion','comentarios'];
    Array.from(container.querySelectorAll('input,textarea,select')).forEach(el=>{
      if (el.type === 'hidden') return;
      if (el.name && optional.includes(el.name)) { el.required = false; return; }
      if (el.type === 'radio') { el.required = !!required; return; }
      el.required = !!required;
    });
  }

  function toggleBlocks(update = true) {
    const attend = form.querySelector('input[name="asiste"]:checked')?.value || "";
    const conditionalBlocks = document.getElementById('conditionalBlocks');
    if (attend.trim().startsWith('Sí')) {
      conditionalBlocks.style.display = '';
      setRequiredIn(conditionalBlocks, true);
      if (update) updateCompanions();
      toggleTransportQuestion();
    } else {
      conditionalBlocks.style.display = 'none';
      Array.from(conditionalBlocks.querySelectorAll('input,textarea,select')).forEach(el=>{
        if (el.type === 'hidden') return;
        el.required = false;
        if (el.type === 'radio' || el.type === 'checkbox') el.checked = false;
        else el.value = '';
      });
      companionsList.innerHTML = '';
    }
  }

  // listeners
  form.querySelectorAll('input[name="asiste"]').forEach(r => r.addEventListener('change', ()=>toggleBlocks(true)));
  if (numInvInput) numInvInput.addEventListener('input', updateCompanions);
  if (transporteSelect) transporteSelect.addEventListener('change', toggleTransportQuestion);

  // iframe load: se dispara cuando el Web App responde -> consideramos envío OK
  const iframe = document.getElementById('hidden_iframe');
  if (iframe) {
    iframe.addEventListener('load', () => {
      // una carga del iframe indica que el servidor respondió (no podemos leer la respuesta por CORS)
      status.classList.remove('hidden');
      status.textContent = '✅ ¡Confirmación recibida! Gracias.';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Enviar RSVP';
      // opción: limpiar form
      form.reset();
      updateCompanions();
      toggleBlocks(true);
    });
  }

  // submit: preparamos campos y hacemos form.submit() (no fetch)
  form.addEventListener('submit', (evt) => {
    evt.preventDefault();

    // validar HTML5 antes de enviar
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    // concatenar nombres de acompañantes en un campo oculto adicional para enviar
    // creamos/actualizamos un input hidden con name "acompanantes"
    const companionInputs = Array.from(companionsList.querySelectorAll('input'))
      .map(i => i.value.trim())
      .filter(Boolean);
    let hidden = form.querySelector('input[name="acompanantes"]');
    if (!hidden) {
      hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = 'acompanantes';
      form.appendChild(hidden);
    }
    hidden.value = companionInputs.join('; ');

    // UI
    submitBtn.disabled = true;
    submitBtn.textContent = 'Enviando...';
    status.classList.add('hidden');

    // enviar por POST al Apps Script (form target = hidden_iframe evitará navegación de la página)
    form.submit();
  });

  // inicializaciones
  updateCompanions();
  toggleTransportQuestion();
  toggleBlocks(true);

})();
</script>
</body>
</html>
